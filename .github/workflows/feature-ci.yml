name: Feature Branch CI

# è§¸ç™¼æ¢ä»¶ï¼šfeature åˆ†æ”¯çš„æ¨é€å’Œ PR
on:
  push:
    branches:
      - 'feature/**'
  pull_request:
    branches:
      - development
    types: [opened, synchronize, reopened]

# ä¸¦ç™¼æ§åˆ¶ï¼šåŒä¸€ PR åªåŸ·è¡Œæœ€æ–°çš„å·¥ä½œæµç¨‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
        continue-on-error: false
      
      - name: Check TypeScript
        run: npx tsc --noEmit
        continue-on-error: true
      
      - name: Report lint results
        if: always()
        run: |
          echo "## ğŸ“ Code Quality Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ESLint check completed" >> $GITHUB_STEP_SUMMARY

  # å‰ç«¯å»ºç½®æ¸¬è©¦
  frontend-build:
    name: Frontend Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
      
      - name: Check build size
        run: |
          if [ -d "dist" ]; then
            SIZE=$(du -sh dist | cut -f1)
            echo "ğŸ“¦ Build size: $SIZE" >> $GITHUB_STEP_SUMMARY
            ls -lh dist/assets/*.js | head -5 >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: dist/
          retention-days: 7

  # Lambda æœå‹™æ¸¬è©¦
  lambda-services:
    name: Lambda Tests - ${{ matrix.service }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        service: [items, auth, health]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies for ${{ matrix.service }}
        run: |
          cd services/${{ matrix.service }}
          npm ci
      
      - name: Run tests for ${{ matrix.service }}
        run: |
          cd services/${{ matrix.service }}
          if grep -q "\"test\":" package.json && ! grep -q "echo.*No tests" package.json; then
            npm test -- --coverage
          else
            echo "âš ï¸  No tests configured for ${{ matrix.service }}"
          fi
      
      - name: Upload coverage
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}-${{ github.sha }}
          path: services/${{ matrix.service }}/coverage/
          retention-days: 7
        continue-on-error: true

  # CDK åŸºç¤è¨­æ–½é©—è­‰
  infrastructure-validation:
    name: Infrastructure Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install CDK dependencies
        run: |
          cd infra
          npm ci
      
      - name: Build CDK TypeScript
        run: |
          cd infra
          npm run build
      
      - name: CDK Synth (Dry Run)
        run: |
          cd infra
          npx cdk synth --no-lookups > /dev/null
          echo "âœ… CDK synthesis successful" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: Check CDK diff
        run: |
          cd infra
          echo "## ğŸ—ï¸  Infrastructure Changes" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          npx cdk diff --no-lookups 2>&1 | head -50 >> $GITHUB_STEP_SUMMARY || echo "No infrastructure deployed yet" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

  # å®‰å…¨æ€§æƒæ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          echo "## ğŸ”’ Security Scan" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY || echo "Some vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
      
      - name: Check for secrets
        run: |
          if grep -r -i "aws_access_key\|aws_secret\|password.*=" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" .; then
            echo "âš ï¸  Potential secrets found in code!" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… No hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  # PR ç›¸é—œæª¢æŸ¥
  pr-checks:
    name: Pull Request Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?:.+ ]]; then
            echo "âœ… PR title follows conventional commits: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  PR title should follow format: type(scope): description" >> $GITHUB_STEP_SUMMARY
            echo "Examples: feat: add login, fix(api): correct endpoint" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check for BREAKING CHANGES
        run: |
          if git log --format=%B origin/development..HEAD | grep -q "BREAKING CHANGE"; then
            echo "âš ï¸  This PR contains BREAKING CHANGES" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Count changed files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/development...HEAD | wc -l)
          echo "ğŸ“ Files changed: $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          
          if [ $CHANGED_FILES -gt 50 ]; then
            echo "âš ï¸  Large PR detected ($CHANGED_FILES files). Consider splitting." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check branch is up to date
        run: |
          git fetch origin development
          BEHIND=$(git rev-list --count HEAD..origin/development)
          if [ $BEHIND -gt 0 ]; then
            echo "âš ï¸  Branch is $BEHIND commits behind development" >> $GITHUB_STEP_SUMMARY
            echo "Consider rebasing: git rebase origin/development" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Branch is up to date with development" >> $GITHUB_STEP_SUMMARY
          fi

  # æœ€çµ‚å½™ç¸½
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-build, lambda-services, infrastructure-validation, security-scan]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# ğŸš€ Feature Branch CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.frontend-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lambda Tests | ${{ needs.lambda-services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.infrastructure-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Check overall status
        run: |
          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.frontend-build.result }}" == "success" ] && \
             [ "${{ needs.lambda-services.result }}" == "success" ] && \
             [ "${{ needs.infrastructure-validation.result }}" == "success" ]; then
            echo "## âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This branch is ready to merge into \`development\`" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "## âŒ Some checks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed jobs above and fix the issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # è‡ªå‹•æ¨™è¨˜ PR (å¯é¸)
  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
